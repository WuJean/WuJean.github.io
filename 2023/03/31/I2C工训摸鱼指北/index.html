<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>I2C工训摸鱼指北 | 岳麓山下你和我</title><meta name="author" content="WuJean"><meta name="copyright" content="WuJean"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="首先先甩个图上来，这些东西我真的是一点都没听，每次去工训就和傻子一样坐着，直到要验收了才想起居然要做东西。相信很多同学有和我一样的感受，所以我在验收前一周的工训课上决定发奋图强，一个小时速通工训，为后来者减少这个东西的恶心程度。（其实是I2C协议让我提起了一点学习的兴趣） 速通开始 如果仅仅是要过的话，只要完成单元测试，上课没去别被点到（第二次课开始可能点名），提交了实验报告就能过了。但是我们速">
<meta property="og:type" content="article">
<meta property="og:title" content="I2C工训摸鱼指北">
<meta property="og:url" content="http://wujean.github.io/2023/03/31/I2C%E5%B7%A5%E8%AE%AD%E6%91%B8%E9%B1%BC%E6%8C%87%E5%8C%97/index.html">
<meta property="og:site_name" content="岳麓山下你和我">
<meta property="og:description" content="首先先甩个图上来，这些东西我真的是一点都没听，每次去工训就和傻子一样坐着，直到要验收了才想起居然要做东西。相信很多同学有和我一样的感受，所以我在验收前一周的工训课上决定发奋图强，一个小时速通工训，为后来者减少这个东西的恶心程度。（其实是I2C协议让我提起了一点学习的兴趣） 速通开始 如果仅仅是要过的话，只要完成单元测试，上课没去别被点到（第二次课开始可能点名），提交了实验报告就能过了。但是我们速">
<meta property="og:locale">
<meta property="og:image" content="http://wujean.github.io/img/avatar.png">
<meta property="article:published_time" content="2023-03-31T02:23:54.000Z">
<meta property="article:modified_time" content="2023-09-05T01:21:03.712Z">
<meta property="article:author" content="WuJean">
<meta property="article:tag" content="HNU">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://wujean.github.io/img/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://wujean.github.io/2023/03/31/I2C%E5%B7%A5%E8%AE%AD%E6%91%B8%E9%B1%BC%E6%8C%87%E5%8C%97/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'I2C工训摸鱼指北',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-05 09:21:03'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/ToDo/"><span> 待办事项</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="岳麓山下你和我"><span class="site-name">岳麓山下你和我</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/ToDo/"><span> 待办事项</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">I2C工训摸鱼指北</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-03-31T02:23:54.000Z" title="Created 2023-03-31 10:23:54">2023-03-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-09-05T01:21:03.712Z" title="Updated 2023-09-05 09:21:03">2023-09-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">6.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>26min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="I2C工训摸鱼指北"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230331103106836.png" alt="image-20230331103106836"></p>
<p>首先先甩个图上来，这些东西我真的是一点都没听，每次去工训就和傻子一样坐着，直到要验收了才想起居然要做东西。相信很多同学有和我一样的感受，所以我在验收前一周的工训课上决定发奋图强，一个小时速通工训，为后来者减少这个东西的恶心程度。（其实是I2C协议让我提起了一点学习的兴趣）</p>
<h1 id="速通开始"><a href="#速通开始" class="headerlink" title="速通开始"></a>速通开始</h1><p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230331103444041.png" alt="image-20230331103444041"></p>
<p>如果仅仅是要过的话，只要完成单元测试，上课没去别被点到（第二次课开始可能点名），提交了实验报告就能过了。但是我们速通需要的是精致速通，如何花最少的时间学到一点点东西；拿到不算低的分数；收获一点点成就感，尤为重要。</p>
<p>我们看占比最多的实验报告到底包含了什么内容：</p>
<p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230331103740363.png" alt="image-20230331103740363"></p>
<ol>
<li>编写TestBench的内容（一点点课后习题）可以加点仿真的内容</li>
<li>ModelSim工具的使用（操作的截图）可以和上一步合并</li>
<li>分析代码</li>
<li>实验总结</li>
</ol>
<h2 id="实验报告部分（1）"><a href="#实验报告部分（1）" class="headerlink" title="实验报告部分（1）"></a>实验报告部分（1）</h2><p>如何描述组合电路 、时序电路、状态机？</p>
<ul>
<li><p>组合电路是一种最基本的电路，它的输出只取决于当前的输入，没有任何延迟或存储，因此在响应时间上非常快速。它通常用于执行简单的逻辑操作，例如布尔运算、逻辑比较和选择。</p>
</li>
<li><p>时序电路是一种电路，它包含了存储器元件，可以在内部存储一定数量的位或字，并且可以根据时钟信号进行读写。时序电路的输出不仅取决于当前输入，还取决于存储器的状态和历史，因此具有一定的延迟和存储能力。</p>
</li>
<li><p>状态机是一种特殊的时序电路，它具有多个状态和转移条件，可以响应不同的输入信号并在不同的状态之间转换。状态机通常用于控制系统，例如逻辑控制器、计数器和序列检测器等。状态机通常由时序电路和组合逻辑电路组成，可以描述为时序电路的一种应用。</p>
</li>
</ul>
<p>它们之间的关系可以这样描述：组合电路是时序电路和状态机的基础，因为它们都可以由基本的逻辑门和它们的组合构成。时序电路是状态机的基础，因为状态机可以看作是一种具有特定状态转移规则的时序电路。状态机可以用于控制时序电路的状态转移，例如控制存储器的读写、控制数据通路的选择等。</p>
<p>如何编写TestBench？</p>
<p>编写TestBench需要以下步骤：</p>
<ol>
<li>定义测试向量：根据设计规格书，定义输入测试向量，并将其转化为二进制格式，以便仿真器能够读取和应用。</li>
<li>编写测试脚本：使用测试脚本编写仿真环境，设置仿真时钟和仿真周期，以便在仿真器中运行测试向量，并捕获输出信号。测试脚本通常使用HDL（硬件描述语言）编写，例如Verilog、VHDL或SystemVerilog。</li>
<li>仿真执行：运行仿真器，将测试向量提供给设计，并捕获输出信号。对于每个仿真周期，测试脚本会检查输出信号是否与预期的输出信号匹配。如果不匹配，则测试失败。</li>
<li>结果分析：分析仿真结果，检查测试向量是否能够正确覆盖设计的所有状态和操作。如果测试失败，则需要调查问题，并修改设计或测试向量以确保测试覆盖到所有的设计情况。</li>
</ol>
<h2 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h2><p>学习通资料中下载Modelsim&amp;Crack，解压后按ReadMe.txt中的内容执行，有几点需要注意的：</p>
<ul>
<li><p>在执行安装程序的最后一步提示你要重启的时候，选择否</p>
</li>
<li><p>破解软件要记得放到软件安装目录的win64文件夹下，再执行，否则会提示找不到dll文件</p>
</li>
<li><p>设置环境变量的时候要记得添加的是许可证的文件！</p>
</li>
<li><p>打开软件的时候记得使用管理员权限打开，否则会提示找不到许可证</p>
</li>
</ul>
<h2 id="实验报告部分（2）Modelsim的使用"><a href="#实验报告部分（2）Modelsim的使用" class="headerlink" title="实验报告部分（2）Modelsim的使用"></a>实验报告部分（2）Modelsim的使用</h2><p>我们直接使用自定义的FSM工程展示软件的使用</p>
<h3 id="一、自定义说明"><a href="#一、自定义说明" class="headerlink" title="一、自定义说明"></a>一、自定义说明</h3><p>下面是一个状态机，描述一个人一天的活动，包括上课、自习、开会、吃饭等活动。状态不少于10种，不少于5个判断选择。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">// fsm.v</span><br><span class="line"></span><br><span class="line">module fsm (</span><br><span class="line">    input clk,    // 时钟信号</span><br><span class="line">    input rst,    // 复位信号</span><br><span class="line">    input alarm,  // 闹钟信号</span><br><span class="line">    input class,  // 上课信号</span><br><span class="line">    input study,  // 自习信号</span><br><span class="line">    input meet,   // 开会信号</span><br><span class="line">    input lunch,  // 中餐信号</span><br><span class="line">    input dinner, // 晚餐信号</span><br><span class="line">    output reg[3:0] state // 状态输出</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 状态定义</span><br><span class="line">parameter S0 = 0;</span><br><span class="line">parameter S1 = 1;</span><br><span class="line">parameter S2 = 2;</span><br><span class="line">parameter S3 = 3;</span><br><span class="line">parameter S4 = 4;</span><br><span class="line">parameter S5 = 5;</span><br><span class="line">parameter S6 = 6;</span><br><span class="line">parameter S7 = 7;</span><br><span class="line">parameter S8 = 8;</span><br><span class="line">parameter S9 = 9;</span><br><span class="line">parameter S10 = 10;</span><br><span class="line"></span><br><span class="line">// 状态寄存器</span><br><span class="line">reg[3:0] current_state;</span><br><span class="line"></span><br><span class="line">// 初始化状态</span><br><span class="line">initial begin</span><br><span class="line">    current_state = S0;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">// 状态转移</span><br><span class="line">always@(posedge clk, posedge rst) begin</span><br><span class="line">    if (rst) begin</span><br><span class="line">        current_state &lt;= S0;</span><br><span class="line">    end </span><br><span class="line">    else begin</span><br><span class="line">        case(current_state)</span><br><span class="line">            S0: if (alarm) current_state &lt;= S1;</span><br><span class="line">            S1: if (class) current_state &lt;= S2;</span><br><span class="line">            S2: if (study) current_state &lt;= S3;</span><br><span class="line">            S3: if (meet) current_state &lt;= S4;</span><br><span class="line">            S4: if (lunch) current_state &lt;= S5;</span><br><span class="line">            S5: if (alarm) current_state &lt;= S6;</span><br><span class="line">            S6: if (class) current_state &lt;= S7;</span><br><span class="line">            S7: if (study) current_state &lt;= S8;</span><br><span class="line">            S8: if (meet) current_state &lt;= S9;</span><br><span class="line">            S9: if (dinner) current_state &lt;= S10;</span><br><span class="line">        endcase</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">// 输出状态</span><br><span class="line">always@(current_state) begin</span><br><span class="line">    state = current_state;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">endmodule</span><br></pre></td></tr></table></figure>

<p>下面是一个测试程序，用于测试状态机的功能。我们可以通过改变输入信号的值，观察状态机的输出状态，以验证状态机的正确性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">// fsm_tb.v</span><br><span class="line"></span><br><span class="line">module fsm_tb;</span><br><span class="line"></span><br><span class="line">// 时钟信号</span><br><span class="line">reg clk;</span><br><span class="line">always #5 clk = ~clk;</span><br><span class="line"></span><br><span class="line">// 复位信号</span><br><span class="line">reg rst;</span><br><span class="line"></span><br><span class="line">// 输入信号</span><br><span class="line">reg alarm;</span><br><span class="line">reg class;</span><br><span class="line">reg study;</span><br><span class="line">reg meet;</span><br><span class="line">reg lunch;</span><br><span class="line">reg dinner;</span><br><span class="line"></span><br><span class="line">// 输出信号</span><br><span class="line">wire [3:0] state;</span><br><span class="line"></span><br><span class="line">// 实例化被测试模块</span><br><span class="line">fsm dut(</span><br><span class="line">.clk(clk),</span><br><span class="line">.rst(rst),</span><br><span class="line">.alarm(alarm),</span><br><span class="line">.class(class),</span><br><span class="line">.study(study),</span><br><span class="line">.meet(meet),</span><br><span class="line">.lunch(lunch),</span><br><span class="line">.dinner(dinner),</span><br><span class="line">.state(state)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 初始化</span><br><span class="line">initial begin</span><br><span class="line">clk = 0;</span><br><span class="line">rst = 1;</span><br><span class="line">alarm = 0;</span><br><span class="line">class = 0;</span><br><span class="line">study = 0;</span><br><span class="line">meet = 0;</span><br><span class="line">lunch = 0;</span><br><span class="line">dinner = 0;</span><br><span class="line">#5 rst = 0; // 释放复位</span><br><span class="line">#250 $finish; // 结束仿真</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">// 测试用例</span><br><span class="line">always@(posedge clk) begin</span><br><span class="line">case($time)</span><br><span class="line">5: alarm = 1;</span><br><span class="line">15: alarm = 0;</span><br><span class="line">25: class = 1;</span><br><span class="line">35: class = 0;</span><br><span class="line">45: study = 1;</span><br><span class="line">55: study = 0;</span><br><span class="line">65: meet = 1;</span><br><span class="line">75: meet = 0;</span><br><span class="line">85: lunch = 1;</span><br><span class="line">95: lunch = 0;</span><br><span class="line">105: alarm = 1;</span><br><span class="line">115: alarm = 0;</span><br><span class="line">125: class = 1;</span><br><span class="line">135: class = 0;</span><br><span class="line">145: study = 1;</span><br><span class="line">155: study = 0;</span><br><span class="line">165: meet = 1;</span><br><span class="line">175: meet = 0;</span><br><span class="line">185: lunch = 1;</span><br><span class="line">195: lunch = 0;</span><br><span class="line">205: dinner = 1;</span><br><span class="line">215: dinner = 0;</span><br><span class="line">endcase</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">// 输出状态</span><br><span class="line">always@(posedge clk) begin</span><br><span class="line">$display(&quot;Time=%d, State=%d&quot;, $time, state);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">endmodule</span><br></pre></td></tr></table></figure>

<p> 我们可以按照以下步骤进行仿真：</p>
<ol>
<li><p>建立工程 </p>
</li>
<li><p>添加代码文件 <code>fsm.v</code> 和 <code>fsm_tb.v</code> </p>
</li>
<li><p>编译代码 </p>
</li>
<li><p>启动仿真</p>
</li>
<li><p>添加波形信号 </p>
</li>
<li><p>执行仿真流程 </p>
<p>最后，我们可以观察波形图，以验证状态机的功能。波形图应该显示出输入信号和输出状态随时间的变化。</p>
</li>
</ol>
<p>编写完fsm.v以及fsm_tv.v后我们新建工程：</p>
<p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402132931877.png" alt="image-20230402132931877"></p>
<p>将两个文件添加到工程中：</p>
<p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402133013295.png" alt="image-20230402133013295"></p>
<p>编译所有程序：</p>
<p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402133202091.png" alt="image-20230402133202091"></p>
<p>在view中找到找到library，在work中找到_db文件，右键选择仿真。 （一定要在这里打开！）</p>
<p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402154037002.png" alt="image-20230402154037002"></p>
<p>编译出波形（妈的我调了两个小时）这边建议不要调直接抄我的</p>
<p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402152735372.png" alt="image-20230402152735372"></p>
<p>第二个任务到此结束，这边建议如果要自己写的话用异步的，且判断跳转最好是直接跳转到下一状态，不然很容易弄混掉，调试起来极其困难。</p>
<p>本来想摸鱼来着的现在把这东西的操作和原理学的差不多了。。。。</p>
<h2 id="实验报告（3）EEPRROM读写代码及仿真"><a href="#实验报告（3）EEPRROM读写代码及仿真" class="headerlink" title="实验报告（3）EEPRROM读写代码及仿真"></a>实验报告（3）EEPRROM读写代码及仿真</h2><h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>I2C（Inter-Integrated Circuit）是一种串行通信协议，通常用于连接多个数字电路芯片。它由飞利浦（Philips）公司在1980年代开发，现在已成为一种标准的总线协议。I2C协议需要两个信号线：SCL（串行时钟）和SDA（串行数据）。I2C总线支持多主机配置，即多个主机可以访问同一组设备。</p>
<p>EEPROM（Electrically Erasable Programmable Read-Only Memory）是一种可以在电子设备上存储数据的非易失性存储器。它与普通的ROM（Read-Only Memory）不同，可以通过电子擦除和编程操作来修改存储的数据。EEPROM通常被用作存储系统配置信息和其他重要的数据。</p>
<p>在一个I2C总线上连接一个EEPROM设备需要指定一个设备地址。EEPROM可以通过I2C总线进行读写操作。写操作需要指定要写入的内存地址和写入的数据。读操作需要指定要读取的内存地址，并从设备中读取数据。对EEPROM的读写操作通常被称为“Byte Write”和“Random Read”。在“Byte Write”操作中，单个字节被写入EEPROM。在“Random Read”操作中，从EEPROM中读取单个字节的数据。</p>
<h4 id="I2C是如何工作的"><a href="#I2C是如何工作的" class="headerlink" title="I2C是如何工作的"></a>I2C是如何工作的</h4><p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402172437019.png"></p>
<p>可以理解为：</p>
<ul>
<li>SCL提供时钟信号</li>
<li>SDA根据时钟信号来传输数据</li>
</ul>
<p>I2C通信协议是一个基于起始条件和停止条件的序列化协议。下面是一个基本的I2C通信过程：</p>
<ol>
<li>主机发送起始条件信号（START）。</li>
<li>主机发送设备地址，以及读&#x2F;写操作位（RW）。</li>
<li>设备返回应答信号（ACK）。</li>
<li>主机发送内存地址。</li>
<li>设备返回应答信号。</li>
<li>主机发送数据。</li>
<li>设备返回应答信号。</li>
<li>主机发送停止条件信号（STOP）。</li>
</ol>
<p>对于“Byte Write”操作，主机发送起始条件信号后，发送设备地址和写操作位。设备返回应答信号后，主机发送内存地址，并等待设备返回应答信号。然后，主机发送要写入的单个字节，并等待设备返回应答信号。最后，主机发送停止条件信号。</p>
<p>对于“Random Read”操作，主机发送起始条件信号后，发送设备地址和写操作位。设备返回应答信号后，主机发送内存地址，并等待设备返回应答信号。主机然后发送重复起始条件信号（RESTART），并发送设备地址和读操作位。设备返回应答信号后，设备发送一个字节的数据。主机返回应答信号后，设备可以继续发送更多的数据或发送停止条件信号。</p>
<h4 id="如何与EEPRROM结合"><a href="#如何与EEPRROM结合" class="headerlink" title="如何与EEPRROM结合"></a>如何与EEPRROM结合</h4><p>要与EEPROM结合使用，需要编写一个I2C总线驱动程序和一个EEPROM设备驱动程序。</p>
<p>I2C总线驱动程序负责管理I2C总线的通信，发送起始条件信号、设备地址、读&#x2F;写操作位、内存地址和数据，并等待设备返回应答信号。主机可以使用这个驱动程序与多个设备进行通信。</p>
<p>EEPROM设备驱动程序负责解析主机发送的命令，执行相应的读写操作，并返回数据或状态信息。EEPROM驱动程序通常包括以下函数：</p>
<ol>
<li>读取字节函数：根据指定的内存地址从EEPROM中读取一个字节的数据。</li>
<li>写入字节函数：将一个字节的数据写入指定的内存地址。</li>
<li>读取数据函数：从EEPROM中读取指定长度的数据。</li>
<li>写入数据函数：将指定长度的数据写入EEPROM。</li>
</ol>
<p>这些函数可以根据具体的EEPROM型号和应用需求进行实现。主机可以通过这些函数进行“Byte Write”和“Random Read”操作。</p>
<p>在编写EEPROM设备驱动程序时，需要注意EEPROM的地址范围和操作时序。不同型号的EEPROM可能有不同的地址范围和操作时序，需要仔细查看其数据手册。此外，还需要考虑对数据的保护和错误检测机制，以确保数据的完整性和可靠性。</p>
<h3 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h3><ol>
<li>在ModelSim建立工程，在波形窗口分析各个信号的作用；</li>
<li>能结合ModelSim仿真波形理解每一行代码的作用；</li>
<li>参考设计文件仅实现了“Byte Write”和“Random Read”功能，如能实现更多读写模式将加分。</li>
</ol>
<p>既然是摸鱼那就只做前两个就行了</p>
<ol>
<li>编写编写设计文件和TestBench文件，实现对EEPROM的读写功能验证<ol>
<li>设计文件（i2c.v)：实现对EEPROM模型的“Byte Write”和“Random Read”功能；</li>
<li>测试文件（i2c_tb.v)：实现“Byte Write”和“Random Read”的功能验证；</li>
<li>建立完整的工程，编译正确，波形能证明读写功能的正确性。</li>
<li>工程目录如下图所示：</li>
</ol>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402160221027.png" alt="image-20230402160221027"></p>
<p>这边我们直接使用参考的设计文件：（看起来好像要自己手打）</p>
<h3 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">`timescale 1ns / 1ps //时间单位1ns，精度1ps</span><br><span class="line">module i2c(</span><br><span class="line">input clk, //时钟</span><br><span class="line">input rstn, //复位</span><br><span class="line">input write_op, //写操作</span><br><span class="line">input [7:0]write_data, //需要写入的数据</span><br><span class="line">input read_op, //读操作</span><br><span class="line">output reg [7:0]read_data, //读出的数据</span><br><span class="line">input [7:0]addr, //数据地址</span><br><span class="line">output op_done, //操作结束</span><br><span class="line">output reg scl, //scl</span><br><span class="line">inout sda //sda</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h3><p>Byte Write : START + DEVICE +ACK + ADDR + ACK + DATA + ACK + STOP         </p>
<p>Random Read : START + DEVICE + ACK +ADDR + ACK+START + DEVICE + DATA + NO ACK + STOP        </p>
<p>每个状态用8位16进制数表示，对照上面图中SDA上数据传输情况，每一位数据传输都有一个对应的状态，多出了一些等待状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">parameter IDLE =8&#x27;h00,</span><br><span class="line">WAIT_WTICK0=8&#x27;h01,</span><br><span class="line">WAIT_WTICK1=8&#x27;h02,</span><br><span class="line">W_START=8&#x27;h03,</span><br><span class="line">W_DEVICE7=8&#x27;h04,</span><br><span class="line">W_DEVICE6=8&#x27;h05,</span><br><span class="line">W_DEVICE5=8&#x27;h06,</span><br><span class="line">W_DEVICE4=8&#x27;h07,</span><br><span class="line">W_DEVICE3=8&#x27;h08,</span><br><span class="line">W_DEVICE2=8&#x27;h09,</span><br><span class="line">W_DEVICE1=8&#x27;h0a,</span><br><span class="line">W_DEVICE0=8&#x27;h0b,</span><br><span class="line">W_DEVACK=8&#x27;h0c,</span><br><span class="line">W_ADDRES7=8&#x27;h0d,</span><br><span class="line">W_ADDRES6=8&#x27;h0e,</span><br><span class="line">W_ADDRES5=8&#x27;h0f,</span><br><span class="line">W_ADDRES4=8&#x27;h10,</span><br><span class="line">W_ADDRES3=8&#x27;h11,</span><br><span class="line">W_ADDRES2=8&#x27;h12,</span><br><span class="line">W_ADDRES1=8&#x27;h13,</span><br><span class="line">W_ADDRES0=8&#x27;h14,</span><br><span class="line">W_AACK=8&#x27;h15,</span><br><span class="line">W_DATA7=8&#x27;h16,</span><br><span class="line">W_DATA6=8&#x27;h17,</span><br><span class="line">W_DATA5=8&#x27;h18,</span><br><span class="line">W_DATA4=8&#x27;h19,</span><br><span class="line">W_DATA3=8&#x27;h1a,</span><br><span class="line">W_DATA2=8&#x27;h1b,</span><br><span class="line">W_DATA1=8&#x27;h1c,</span><br><span class="line">W_DATA0=8&#x27;h1d,</span><br><span class="line">W_DACK=8&#x27;h1e,</span><br><span class="line">WAIT_WTICK3=8&#x27;h1f,</span><br><span class="line">R_START=8&#x27;h20,</span><br><span class="line">R_DEVICE7=8&#x27;h21,</span><br><span class="line">R_DEVICE6=8&#x27;h22,</span><br><span class="line">R_DEVICE5=8&#x27;h23,</span><br><span class="line">R_DEVICE4=8&#x27;h24,</span><br><span class="line">R_DEVICE3=8&#x27;h25,</span><br><span class="line">R_DEVICE2=8&#x27;h26,</span><br><span class="line">R_DEVICE1=8&#x27;h27,</span><br><span class="line">R_DEVICE0=8&#x27;h28,</span><br><span class="line">R_DACK=8&#x27;h29,</span><br><span class="line">R_DATA7=8&#x27;h2a,</span><br><span class="line">R_DATA6=8&#x27;h2b,</span><br><span class="line">R_DATA5=8&#x27;h2c,</span><br><span class="line">R_DATA4=8&#x27;h2d,</span><br><span class="line">R_DATA3=8&#x27;h2e,</span><br><span class="line">R_DATA2=8&#x27;h2f,</span><br><span class="line">R_DATA1=8&#x27;h30,</span><br><span class="line">R_DATA0=8&#x27;h31,</span><br><span class="line">R_NOACK=8&#x27;h32,</span><br><span class="line">S_STOP=8&#x27;h33,</span><br><span class="line">S_STOP0=8&#x27;h34,</span><br><span class="line">S_STOP1=8&#x27;h35,</span><br><span class="line">W_OPOVER=8&#x27;h36;</span><br><span class="line">reg [7:0]i2c,next_i; //当前状态，下一状态</span><br></pre></td></tr></table></figure>

<h3 id="SCL同步"><a href="#SCL同步" class="headerlink" title="SCL同步"></a>SCL同步</h3><p>SCL同步是指当主设备在SCL线上产生时钟脉冲时，从设备能够正确地识别这些脉冲并将数据正确地传输到主设备。</p>
<p>在I2C总线中，主设备控制时钟线，从设备根据主设备的时钟脉冲来同步数据传输。主设备通过发送起始信号和地址信号来选定一个从设备，并向从设备发送或接收数据。当主设备发出一个时钟脉冲时，从设备在接收到脉冲后采样SDA线上的数据。如果数据被正确地采样，从设备会发出一个确认信号（ACK）。</p>
<p>SCL同步对于I2C通信的正确性非常重要，因为如果从设备不能正确地同步时钟脉冲，数据传输可能会出错。在设计I2C接口电路时，需要仔细考虑SCL同步问题，以确保从设备能够正确地识别时钟脉冲并进行数据传输。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">reg [7:0]div_cnt; //时钟计数器</span><br><span class="line">wire scl_tick;</span><br><span class="line">//计数，一个时钟周期div_cnt+1</span><br><span class="line">always @(posedge clk or negedge rstn)</span><br><span class="line">    if(!rstn) div_cnt &lt;=8&#x27;d0;</span><br><span class="line">    else if((i2c==IDLE)|scl_tick) div_cnt &lt;=8&#x27;d0;</span><br><span class="line">    else div_cnt&lt;=div_cnt+1&#x27;b1;</span><br><span class="line">//scl时间</span><br><span class="line">wire scl_ls =(div_cnt==8&#x27;d0); //scl low</span><br><span class="line">wire scl_lc = (div_cnt==8&#x27;d7); //scl low center</span><br><span class="line">wire scl_hs =(div_cnt==8&#x27;d15); //scl high</span><br><span class="line">wire scl_hc = (div_cnt==8&#x27;d22); //scl high center</span><br><span class="line">assign scl_tick = (div_cnt==8&#x27;d29); //一个周期结束</span><br></pre></td></tr></table></figure>

<p>使用SCL同步的好处是，它可以确保数据在传输时被正确地解释和接收，从而减少数据传输错误的发生。此外，SCL还可以用来控制I2C总线上的设备数目，以确保总线上只有一个设备处于活动状态，避免多个设备同时进行数据传输而产生干扰</p>
<h3 id="状态更新"><a href="#状态更新" class="headerlink" title="状态更新"></a>状态更新</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//状态</span><br><span class="line">always @(posedge clk or negedge rstn)</span><br><span class="line">if(!rstn) i2c &lt;=0;</span><br><span class="line">else i2c &lt;= next_i;</span><br></pre></td></tr></table></figure>

<h3 id="读写命令的判断"><a href="#读写命令的判断" class="headerlink" title="读写命令的判断"></a>读写命令的判断</h3><p>读写命令是通过端口输入write_op和read_op确定的，这两个信号是低电平有效，用了wr_op和rd_op两个寄存器把输入的write_op和 read_op取反，这样如果有读或写命令，wr_op或rd_op为1，复位和操作结束(wr_opover)时都要清零，接下来就用wr_op和rd_op判断是否读写了，这里仅仅是把原来低电平有效的信号替换为两个高电平有效信号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">reg wr_op,rd_op; //读写操作</span><br><span class="line">always @ (posedge clk or negedge rstn)</span><br><span class="line">    if(!rstn) wr_op &lt;= 0;</span><br><span class="line">    else if (i2c==IDLE) wr_op &lt;= ~write_op;</span><br><span class="line">    else if(i2c==W_OPOVER) wr_op &lt;=1&#x27;b0;</span><br><span class="line">always @(posedge clk or negedge rstn)</span><br><span class="line">    if(!rstn) rd_op &lt;= 0;</span><br><span class="line">    else if (i2c==IDLE) rd_op &lt;= ~read_op;</span><br><span class="line">    else if(i2c==W_OPOVER) rd_op &lt;=1&#x27;b0;</span><br><span class="line">wire d5ms_over; //等待</span><br></pre></td></tr></table></figure>

<h3 id="下一状态的判断"><a href="#下一状态的判断" class="headerlink" title="下一状态的判断"></a>下一状态的判断</h3><p>代码定义了多个状态，从IDLE（空闲）状态开始。当有读写操作时，状态将转换到WAIT_WTICK0状态，然后转移到W_START状态，再到W_DEVICE0到W_DACK状态，以完成写入操作。同样，当进行读取操作时，状态将转换到WAIT_WTICK3状态，然后转移到R_START状态，再到R_DEVICE0到R_DACK状态，以完成读取操作。</p>
<p>在代码中，SCL_TICK信号表示SCL时钟信号的状态。WR_OP和RD_OP信号表示写入操作和读取操作的状态。状态之间的转换由next_i变量控制。</p>
<p>各个状态的具体含义：</p>
<ul>
<li>IDLE（空闲）状态：系统处于空闲状态，没有进行任何读写操作。</li>
<li>WAIT_WTICK0状态：等待写操作的信号WTICK0，表示系统已准备好接收写入数据。</li>
<li>W_START状态：开始进行写操作。</li>
<li>W_DEVICE0状态：写操作的目标设备为设备0。</li>
<li>W_DACK状态：等待写操作的确认信号DACK，表示写操作已完成。</li>
<li>WAIT_WTICK3状态：等待读操作的信号WTICK3，表示系统已准备好读取数据。</li>
<li>R_START状态：开始进行读操作。</li>
<li>R_DEVICE0状态：读操作的目标设备为设备0。</li>
<li>R_DACK状态：等待读操作的确认信号DACK，表示读操作已完成。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">//下一状态判断</span><br><span class="line">always@(*)</span><br><span class="line">case (i2c)</span><br><span class="line">	IDLE: begin next_i = IDLE;if(wr_op|rd_op) next_i = WAIT_WTICK0;end		//有读写操作跳出空闲状态</span><br><span class="line"></span><br><span class="line">	//wait tick</span><br><span class="line">	WAIT_WTICK0:begin next_i = WAIT_WTICK0;if(scl_tick) next_i=WAIT_WTICK1;end	</span><br><span class="line">	WAIT_WTICK1:begin next_i = WAIT_WTICK1;if(scl_tick) next_i = W_START;end</span><br><span class="line">	</span><br><span class="line">	//START:SCL=1,SDA=1-&gt;0(scl_lc)</span><br><span class="line">	W_START:begin next_i=W_START;if(scl_tick) next_i=W_DEVICE7;end</span><br><span class="line">	</span><br><span class="line">	//DEVICE ADDRESS（1010_000_0(WRITE)）</span><br><span class="line">	W_DEVICE7:begin next_i = W_DEVICE7;if(scl_tick) next_i=W_DEVICE6;end</span><br><span class="line">	W_DEVICE6:begin next_i = W_DEVICE6;if(scl_tick) next_i=W_DEVICE5;end</span><br><span class="line">	W_DEVICE5:begin next_i = W_DEVICE5;if(scl_tick) next_i=W_DEVICE4;end</span><br><span class="line">	W_DEVICE4:begin next_i = W_DEVICE4;if(scl_tick) next_i=W_DEVICE3;end</span><br><span class="line">	W_DEVICE3:begin next_i = W_DEVICE3;if(scl_tick) next_i=W_DEVICE2;end</span><br><span class="line">	W_DEVICE2:begin next_i = W_DEVICE2;if(scl_tick) next_i=W_DEVICE1;end</span><br><span class="line">	W_DEVICE1:begin next_i = W_DEVICE1;if(scl_tick) next_i=W_DEVICE0;end</span><br><span class="line">	W_DEVICE0:begin next_i = W_DEVICE0;if(scl_tick) next_i=W_DEVACK;end</span><br><span class="line">	</span><br><span class="line">	//ACK</span><br><span class="line">	W_DEVACK:begin next_i=W_DEVACK;if(scl_tick) next_i=W_ADDRES7;end</span><br><span class="line">	</span><br><span class="line">	//WORD ADDRESS</span><br><span class="line">	W_ADDRES7 :begin next_i = W_ADDRES7;if(scl_tick) next_i=W_ADDRES6;end</span><br><span class="line">	W_ADDRES6 :begin next_i = W_ADDRES6;if(scl_tick) next_i=W_ADDRES5;end</span><br><span class="line">	W_ADDRES5 :begin next_i = W_ADDRES5;if(scl_tick) next_i=W_ADDRES4;end</span><br><span class="line">	W_ADDRES4 :begin next_i = W_ADDRES4;if(scl_tick) next_i=W_ADDRES3;end</span><br><span class="line">	W_ADDRES3 :begin next_i = W_ADDRES3;if(scl_tick) next_i=W_ADDRES2;end</span><br><span class="line">	W_ADDRES2 :begin next_i = W_ADDRES2;if(scl_tick) next_i=W_ADDRES1;end</span><br><span class="line">	W_ADDRES1 :begin next_i = W_ADDRES1;if(scl_tick) next_i=W_ADDRES0;end</span><br><span class="line">	W_ADDRES0 :begin next_i = W_ADDRES0;if(scl_tick) next_i=W_AACK;end</span><br><span class="line">	</span><br><span class="line">	//ACK</span><br><span class="line">	W_AACK:begin next_i = W_AACK;</span><br><span class="line">				 if(scl_tick&amp;wr_op) next_i=W_DATA7;			//wr_op即写命令，开始写数据</span><br><span class="line">				 else if(scl_tick&amp;rd_op) next_i=WAIT_WTICK3;		//rd_op读命令,则下一状态为WAIT_WTICK3</span><br><span class="line">		   end</span><br><span class="line">	</span><br><span class="line">	//WRITE DATA[7:0]</span><br><span class="line">	W_DATA7:begin next_i=W_DATA7;if(scl_tick)next_i=W_DATA6;end</span><br><span class="line">	W_DATA6:begin next_i=W_DATA6;if(scl_tick)next_i=W_DATA5;end</span><br><span class="line">	W_DATA5:begin next_i=W_DATA5;if(scl_tick)next_i=W_DATA4;end</span><br><span class="line">	W_DATA4:begin next_i=W_DATA4;if(scl_tick)next_i=W_DATA3;end</span><br><span class="line">	W_DATA3:begin next_i=W_DATA3;if(scl_tick)next_i=W_DATA2;end</span><br><span class="line">	W_DATA2:begin next_i=W_DATA2;if(scl_tick)next_i=W_DATA1;end</span><br><span class="line">	W_DATA1:begin next_i=W_DATA1;if(scl_tick)next_i=W_DATA0;end</span><br><span class="line">	W_DATA0:begin next_i=W_DATA0;if(scl_tick)next_i=W_DACK;end</span><br><span class="line">	</span><br><span class="line">	//ACK</span><br><span class="line">	W_DACK:begin next_i=W_DACK; if(scl_tick) next_i=S_STOP;end</span><br><span class="line">	</span><br><span class="line">	//Current Address Read</span><br><span class="line">	//START: SCL=1,SDA=1-&gt;0(scl_lc)</span><br><span class="line">	</span><br><span class="line">	WAIT_WTICK3:begin next_i=WAIT_WTICK3; if(scl_tick) next_i=R_START;end</span><br><span class="line">	R_START:begin next_i=R_START; if(scl_tick)next_i=R_DEVICE7;end</span><br><span class="line">	</span><br><span class="line">	//DEVICE ADDRESS(1010_000_1(READ)) </span><br><span class="line">	R_DEVICE7:begin next_i=R_DEVICE7; if(scl_tick) next_i=R_DEVICE6;end</span><br><span class="line">	R_DEVICE6:begin next_i=R_DEVICE6; if(scl_tick) next_i=R_DEVICE5;end</span><br><span class="line">	R_DEVICE5:begin next_i=R_DEVICE5; if(scl_tick) next_i=R_DEVICE4;end</span><br><span class="line">	R_DEVICE4:begin next_i=R_DEVICE4; if(scl_tick) next_i=R_DEVICE3;end</span><br><span class="line">	R_DEVICE3:begin next_i=R_DEVICE3; if(scl_tick) next_i=R_DEVICE2;end</span><br><span class="line">	R_DEVICE2:begin next_i=R_DEVICE2; if(scl_tick) next_i=R_DEVICE1;end</span><br><span class="line">	R_DEVICE1:begin next_i=R_DEVICE1; if(scl_tick) next_i=R_DEVICE0;end</span><br><span class="line">	R_DEVICE0:begin next_i=R_DEVICE0; if(scl_tick) next_i=R_DACK;end</span><br><span class="line">	</span><br><span class="line">	//ACK</span><br><span class="line">	R_DACK:begin next_i=R_DACK;if(scl_tick) next_i=R_DATA7;end</span><br><span class="line">	</span><br><span class="line">	//READ DATA[7:0], SDA:input</span><br><span class="line">	R_DATA7:begin next_i=R_DATA7;if(scl_tick) next_i=R_DATA6;end</span><br><span class="line">	R_DATA6:begin next_i=R_DATA6;if(scl_tick) next_i=R_DATA5;end</span><br><span class="line">	R_DATA5:begin next_i=R_DATA5;if(scl_tick) next_i=R_DATA4;end</span><br><span class="line">	R_DATA4:begin next_i=R_DATA4;if(scl_tick) next_i=R_DATA3;end</span><br><span class="line">	R_DATA3:begin next_i=R_DATA3;if(scl_tick) next_i=R_DATA2;end</span><br><span class="line">	R_DATA2:begin next_i=R_DATA2;if(scl_tick) next_i=R_DATA1;end</span><br><span class="line">	R_DATA1:begin next_i=R_DATA1;if(scl_tick) next_i=R_DATA0;end</span><br><span class="line">	R_DATA0:begin next_i=R_DATA0;if(scl_tick) next_i=R_NOACK;end</span><br><span class="line">	</span><br><span class="line">	//NO ACK</span><br><span class="line">	R_NOACK:begin next_i=R_NOACK;if(scl_tick) next_i=S_STOP;end</span><br><span class="line">	</span><br><span class="line">	//STOP</span><br><span class="line">	S_STOP:begin next_i=S_STOP;if(scl_tick) next_i=S_STOP0;end</span><br><span class="line">	S_STOP0:begin next_i=S_STOP0;if(scl_tick) next_i=S_STOP1;end</span><br><span class="line">	S_STOP1:begin next_i=S_STOP1;if(scl_tick) next_i=W_OPOVER;end			</span><br><span class="line">	</span><br><span class="line">	//WAIT write_op=0,read_op=0;</span><br><span class="line">	W_OPOVER:begin next_i = W_OPOVER;if(d5ms_over)next_i=IDLE;end		//操作结束回到空闲状态</span><br><span class="line">	default:begin next_i= IDLE;end</span><br><span class="line">endcase</span><br></pre></td></tr></table></figure>

<h3 id="SCL同步实现"><a href="#SCL同步实现" class="headerlink" title="SCL同步实现"></a>SCL同步实现</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//SCL</span><br><span class="line">assign clr_scl=scl_ls&amp;(i2c!=IDLE)&amp;(i2c!=WAIT_WTICK0)&amp;					//clr_scl，scl置0信号</span><br><span class="line">			   (i2c != WAIT_WTICK1)&amp;(i2c!=W_START)&amp;(i2c!=R_START)</span><br><span class="line">			   &amp;(i2c!=S_STOP0)&amp;(i2c!=S_STOP1)&amp;(i2c!=W_OPOVER);</span><br><span class="line"></span><br><span class="line">always @(posedge clk or negedge rstn)</span><br><span class="line">if(!rstn) scl &lt;= 1&#x27;b1;									//复位，scl为高电平</span><br><span class="line">else if(clr_scl) scl &lt;= 1&#x27;b0;								//scl 1-&gt;0</span><br><span class="line">else if(scl_hs) scl &lt;=1&#x27;b1;								//scl 0-&gt;1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="SDA实现"><a href="#SDA实现" class="headerlink" title="SDA实现"></a>SDA实现</h3><p>SDA线是I2C总线上的双向数据线，用于在主设备和从设备之间传输数据。当主设备想要向从设备发送数据时，它将数据写入SDA线，并将时钟信号发送到SCL（Serial Clock）线上。从设备在接收到时钟信号后读取SDA线上的数据。同样地，当从设备想要向主设备发送数据时，它将数据写入SDA线，并等待主设备发送时钟信号</p>
<p><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402172437019.png" alt="image-20230402172437019"></p>
<p>对于i2c_rlf，它是通过对i2c信号的不同取值进行逻辑判断得出的，如果i2c信号满足读写条件，则i2c_rlf信号被置为1，否则被置为0。其中i2c的取值包括写器件地址、写数据地址、写数据、读器件地址、读数据时钟等操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">//SDA</span><br><span class="line">reg [7:0]i2c_reg;</span><br><span class="line">assign start_clr = scl_lc &amp;((i2c==W_START)|(i2c==R_START));				//在scl low center开始读写操作</span><br><span class="line">assign ld_wdevice = scl_lc&amp;(i2c==W_DEVICE7);						//加载器件地址</span><br><span class="line">assign ld_waddres = scl_lc&amp;(i2c==W_ADDRES7);						//加载数据地址</span><br><span class="line">assign ld_wdata= scl_lc&amp;(i2c==W_DATA7);						//加载数据</span><br><span class="line">assign ld_rdevice = scl_lc&amp;(i2c==R_DEVICE7);						//读操作的器件地址</span><br><span class="line">assign noack_set = scl_lc&amp;(i2c==R_NOACK);						//读操作完毕</span><br><span class="line">assign stop_clr = scl_lc&amp;(i2c==S_STOP);						</span><br><span class="line">assign stop_set = scl_lc&amp;((i2c==S_STOP0)|(i2c==WAIT_WTICK3));</span><br><span class="line"></span><br><span class="line">assign i2c_rlf =scl_lc&amp;(								//有读写则i2c_rlf</span><br><span class="line">				(i2c == W_DEVICE6)|</span><br><span class="line">				(i2c == W_DEVICE5)|</span><br><span class="line">				(i2c == W_DEVICE4)|</span><br><span class="line">				(i2c == W_DEVICE3)|</span><br><span class="line">				(i2c == W_DEVICE2)|</span><br><span class="line">				(i2c == W_DEVICE1)|</span><br><span class="line">				(i2c == W_DEVICE0)|</span><br><span class="line">				(i2c == W_ADDRES6)|</span><br><span class="line">				(i2c == W_ADDRES5)|</span><br><span class="line">				(i2c == W_ADDRES4)|</span><br><span class="line">				(i2c == W_ADDRES3)|</span><br><span class="line">				(i2c == W_ADDRES2)|</span><br><span class="line">				(i2c == W_ADDRES1)|</span><br><span class="line">				(i2c == W_ADDRES0)|</span><br><span class="line">				(i2c == W_DATA6)|</span><br><span class="line">				(i2c == W_DATA5)|</span><br><span class="line">				(i2c == W_DATA4)|</span><br><span class="line">				(i2c == W_DATA3)|</span><br><span class="line">				(i2c == W_DATA2)|</span><br><span class="line">				(i2c == W_DATA1)|</span><br><span class="line">				(i2c == W_DATA0)|</span><br><span class="line">				(i2c == R_DEVICE6)|</span><br><span class="line">				(i2c == R_DEVICE5)|</span><br><span class="line">				(i2c == R_DEVICE4)|</span><br><span class="line">				(i2c == R_DEVICE3)|</span><br><span class="line">				(i2c == R_DEVICE2)|</span><br><span class="line">				(i2c == R_DEVICE1)|</span><br><span class="line">				(i2c == R_DEVICE0));</span><br></pre></td></tr></table></figure>

<p>我们结合这两段代码来看，可以很清楚看到我们通过状态判断得到当前状态的信息，生成状态判断码，在时钟上升沿的时候通过状态码执行读写的操作。i2c_rlf为1时i2creg会左移一位，因为sda 是单位宽的，每次把i2creg的最高位送到sda上，因此左移就是一位一位把数据送到sda上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//SDA</span><br><span class="line">reg [7:0]i2c_reg;</span><br><span class="line">assign start_clr = scl_lc &amp;((i2c==W_START)|(i2c==R_START));				//在scl low center开始读写操作</span><br><span class="line">assign ld_wdevice = scl_lc&amp;(i2c==W_DEVICE7);						//加载器件地址</span><br><span class="line">assign ld_waddres = scl_lc&amp;(i2c==W_ADDRES7);						//加载数据地址</span><br><span class="line">assign ld_wdata= scl_lc&amp;(i2c==W_DATA7);						//加载数据</span><br><span class="line">assign ld_rdevice = scl_lc&amp;(i2c==R_DEVICE7);						//读操作的器件地址</span><br><span class="line">assign noack_set = scl_lc&amp;(i2c==R_NOACK);						//读操作完毕</span><br><span class="line">assign stop_clr = scl_lc&amp;(i2c==S_STOP);						</span><br><span class="line">assign stop_set = scl_lc&amp;((i2c==S_STOP0)|(i2c==WAIT_WTICK3));</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">always@(posedge clk or negedge rstn)</span><br><span class="line">if(!rstn) i2c_reg &lt;= 8&#x27;hff;								//复位，高电平</span><br><span class="line">else if(start_clr) i2c_reg &lt;= 8&#x27;h00;							//开始读写，低电平</span><br><span class="line">else if(ld_wdevice) i2c_reg &lt;= &#123;4&#x27;b1010,3&#x27;b000,1&#x27;b0&#125;;					//10100000 写</span><br><span class="line">else if(ld_waddres) i2c_reg &lt;= addr;							//加载数据地址</span><br><span class="line">else if(ld_wdata) i2c_reg &lt;= write_data;							//加载写入的数据</span><br><span class="line">else if(ld_rdevice) i2c_reg &lt;= &#123;4&#x27;b1010,3&#x27;b000,1&#x27;b1&#125;;					//10100001 读</span><br><span class="line">else if(noack_set) i2c_reg &lt;= 8&#x27;hff;							//NOACK</span><br><span class="line">else if(stop_clr) i2c_reg &lt;= 8&#x27;h00;</span><br><span class="line">else if(stop_set) i2c_reg &lt;= 8&#x27;hff;</span><br><span class="line">else if(i2c_rlf) i2c_reg &lt;= &#123;i2c_reg[6:0],1&#x27;b0&#125;;						//左移</span><br></pre></td></tr></table></figure>

<p> <code>assign sda= sda_en?sda_o: 1&#39;bz;</code> 是将 SDA 使能为 1 时，SDA 的输出为 <code>sda_o</code>，否则为高阻态（<code>1&#39;bz</code>）。<code>assign clr_sdaen</code> 和 <code>assign set_sdaen</code> 是用来控制 SDA 使能信号的，具体是根据 I2C 协议状态机的状态来确定。在 <code>always</code> 块中，如果 <code>sda_wr</code> 为 1，就将 SDA 的值左移一位，然后将当前的 SDA 线的值赋给最低位。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">assign sda_o = i2c_reg[7];								//sda输出</span><br><span class="line">assign clr_sdaen = (i2c==IDLE)|							//sda使能置0信号</span><br><span class="line">				   (scl_lc&amp;(</span><br><span class="line">				   (i2c==W_DEVACK)|</span><br><span class="line">				   (i2c==W_AACK)|</span><br><span class="line">				   (i2c==W_DACK)|</span><br><span class="line">				   (i2c==R_DACK)|</span><br><span class="line">				   (i2c==R_DATA7)));</span><br><span class="line"></span><br><span class="line">assign set_sdaen = scl_lc&amp;(								//sda使能置1信号</span><br><span class="line">				   (i2c==WAIT_WTICK0)|</span><br><span class="line">				   (i2c==W_ADDRES7)|</span><br><span class="line">				   (i2c==W_DATA7)|</span><br><span class="line">				   (i2c==WAIT_WTICK3)|</span><br><span class="line">				   (i2c==S_STOP)|</span><br><span class="line">				   (i2c==R_NOACK));</span><br><span class="line"></span><br><span class="line">reg sda_en;</span><br><span class="line">always @(posedge clk or negedge rstn)</span><br><span class="line">if(!rstn) sda_en &lt;= 0;								</span><br><span class="line">else if (clr_sdaen) sda_en &lt;=0;</span><br><span class="line">else if(set_sdaen) sda_en &lt;= 1&#x27;b1;</span><br><span class="line"></span><br><span class="line">assign sda= sda_en?sda_o: 1&#x27;bz;							//sda使能为1时sda可工作</span><br><span class="line"></span><br><span class="line">assign sda_wr = scl_hc &amp;(								//读数据</span><br><span class="line">				(i2c==R_DATA7)|</span><br><span class="line">				(i2c==R_DATA6)|</span><br><span class="line">				(i2c==R_DATA5)|</span><br><span class="line">				(i2c==R_DATA4)|</span><br><span class="line">				(i2c==R_DATA3)|</span><br><span class="line">				(i2c==R_DATA2)|</span><br><span class="line">				(i2c==R_DATA1)|</span><br><span class="line">				(i2c==R_DATA0));</span><br><span class="line"></span><br><span class="line">always@(posedge clk or negedge rstn)</span><br><span class="line">if(!rstn) read_data &lt;= 0;</span><br><span class="line">else if(sda_wr) read_data &lt;= &#123;read_data[6:0],sda&#125;;					//左移读入数据</span><br></pre></td></tr></table></figure>

<p>其中i2c表示当前的写操作状态，op_done表示写操作是否完成，d5ms_cnt用于计数5毫秒的时间，d5ms_over表示5毫秒时间已经过去。</p>
<p>在具体实现上，代码中使用了assign语句和always语句来实现状态变量的赋值和状态转移，使用了时序逻辑实现了计数器功能。在写操作完成后，d5ms_over会被设置为1，表示可以进行下一次写操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//op_done</span><br><span class="line">assign op_done = (i2c == W_OPOVER);						//操作结束</span><br><span class="line"></span><br><span class="line">//Write Cycle(5ms)</span><br><span class="line">//6MHZ = 166ns,5ms/166ns = 31</span><br><span class="line">reg [12:0] d5ms_cnt;</span><br><span class="line">always @(posedge clk or negedge rstn)</span><br><span class="line">if(!rstn)    d5ms_cnt &lt;= 8&#x27;d0;</span><br><span class="line">else if(i2c==IDLE) d5ms_cnt &lt;= 8&#x27;d0;</span><br><span class="line">else if(i2c==W_OPOVER) d5ms_cnt &lt;= d5ms_cnt + 1&#x27;b1;</span><br><span class="line"></span><br><span class="line">assign d5ms_over = (d5ms_cnt==13&#x27;h1FFF);</span><br></pre></td></tr></table></figure>

<h1 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h1><p>在进行 I2C 协议 EEPROM 读写代码仿真实验中，我对 I2C 协议以及 Verilog HDL 的应用有了更深入的了解。</p>
<p>首先，在进行实验前，我通过学习相关的 I2C 协议知识，了解了 I2C 协议的传输方式、信号时序以及协议的基本操作。这些知识对我在仿真实验中理解代码的意义以及分析仿真结果有很大的帮助。</p>
<p>其次，在编写代码时，我需要按照 I2C 协议的时序要求，对代码进行时序分析，并根据时序分析结果编写 Verilog HDL 代码。在这个过程中，我深刻体会到了 Verilog HDL 的强大和灵活，可以实现非常复杂的功能。</p>
<p>最后，在进行仿真实验时，我利用 Modelsim工具对代码进行仿真，观察仿真结果并进行分析。通过仿真实验，我不仅验证了代码的正确性，还能进一步优化代码的性能和实现效果，为后续的硬件实现提供了有价值的参考。</p>
<p>总之，通过这次实验，我对 I2C 协议和 Verilog HDL 有了更深入的了解，也对数字电路设计和硬件实现有了更深刻的认识，相信这些知识对我的未来学习和研究会有很大的帮助。</p>
<h1 id="实验验收"><a href="#实验验收" class="headerlink" title="实验验收"></a>实验验收</h1><p>真的很水，可能老师也烦了。以下是本人验收的过程，验收难度可能因老师而异。</p>
<ul>
<li>在quarter2中按照教程分配好管教然后下载到板子中</li>
<li>给老师演示以下板子上的操作，解释一下按键和设置是啥意思</li>
<li>打开仿真软件仿真波形（完成后已经有80的及格分了）</li>
<li>解释波形</li>
<li>解释代码（讲个大概模块的功能和架构）</li>
</ul>
<p>希望大家都能水过去！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://wujean.github.io">WuJean</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://wujean.github.io/2023/03/31/I2C%E5%B7%A5%E8%AE%AD%E6%91%B8%E9%B1%BC%E6%8C%87%E5%8C%97/">http://wujean.github.io/2023/03/31/I2C%E5%B7%A5%E8%AE%AD%E6%91%B8%E9%B1%BC%E6%8C%87%E5%8C%97/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/HNU/">HNU</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/02/Make-and-Makefile/" title="Make and Makefile"><img class="cover" src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20230402223938899.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Make and Makefile</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/26/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%9F%9F%E5%90%8D%E8%BD%ACcloudflare/" title="腾讯云域名转cloudflare"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">腾讯云域名转cloudflare</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">WuJean</div><div class="author-info__description">一些生活的片段</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/WuJean"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/WuJean" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:wujean1220@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9F%E9%80%9A%E5%BC%80%E5%A7%8B"><span class="toc-number">1.</span> <span class="toc-text">速通开始</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A%E9%83%A8%E5%88%86%EF%BC%881%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">实验报告部分（1）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">安装软件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A%E9%83%A8%E5%88%86%EF%BC%882%EF%BC%89Modelsim%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">实验报告部分（2）Modelsim的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.1.</span> <span class="toc-text">一、自定义说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A%EF%BC%883%EF%BC%89EEPRROM%E8%AF%BB%E5%86%99%E4%BB%A3%E7%A0%81%E5%8F%8A%E4%BB%BF%E7%9C%9F"><span class="toc-number">1.4.</span> <span class="toc-text">实验报告（3）EEPRROM读写代码及仿真</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.4.1.</span> <span class="toc-text">写在前面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#I2C%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">I2C是如何工作的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%B8%8EEEPRROM%E7%BB%93%E5%90%88"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">如何与EEPRROM结合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9"><span class="toc-number">1.4.2.</span> <span class="toc-text">实验内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.4.3.</span> <span class="toc-text">端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.4.</span> <span class="toc-text">状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SCL%E5%90%8C%E6%AD%A5"><span class="toc-number">1.4.5.</span> <span class="toc-text">SCL同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0"><span class="toc-number">1.4.6.</span> <span class="toc-text">状态更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E5%91%BD%E4%BB%A4%E7%9A%84%E5%88%A4%E6%96%AD"><span class="toc-number">1.4.7.</span> <span class="toc-text">读写命令的判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E4%B8%80%E7%8A%B6%E6%80%81%E7%9A%84%E5%88%A4%E6%96%AD"><span class="toc-number">1.4.8.</span> <span class="toc-text">下一状态的判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SCL%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.9.</span> <span class="toc-text">SCL同步实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SDA%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.10.</span> <span class="toc-text">SDA实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="toc-number">2.</span> <span class="toc-text">实验总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E9%AA%8C%E6%94%B6"><span class="toc-number">3.</span> <span class="toc-text">实验验收</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/04/08/%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEclash%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/" title="腾讯云服务器配置clash科学上网"><img src="https://raw.githubusercontent.com/WuJean/Picgo-blog/main/image-20240410204314693.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="腾讯云服务器配置clash科学上网"/></a><div class="content"><a class="title" href="/2024/04/08/%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEclash%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/" title="腾讯云服务器配置clash科学上网">腾讯云服务器配置clash科学上网</a><time datetime="2024-04-08T14:22:36.000Z" title="Created 2024-04-08 22:22:36">2024-04-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/18/Docker-Compose-K8S-%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" title="Docker Compose &amp;&amp; K8S 部署项目实战">Docker Compose &amp;&amp; K8S 部署项目实战</a><time datetime="2024-03-18T05:18:46.000Z" title="Created 2024-03-18 13:18:46">2024-03-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/13/nginx%E5%AE%B9%E5%99%A8%E5%8C%96%E8%B8%A9%E5%9D%91%E9%9B%86%E9%94%A6/" title="nginx容器化踩坑集锦">nginx容器化踩坑集锦</a><time datetime="2024-03-13T13:28:12.000Z" title="Created 2024-03-13 21:28:12">2024-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/12/Docker-%E5%A4%9A%E5%AE%B9%E5%99%A8%E9%80%9A%E4%BF%A1%E5%AE%9E%E6%88%98-%EF%BC%88node-mongDB-nginx%EF%BC%89/" title="Docker-多容器通信实战-（node+mongDB+nginx）">Docker-多容器通信实战-（node+mongDB+nginx）</a><time datetime="2024-03-12T11:49:37.000Z" title="Created 2024-03-12 19:49:37">2024-03-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/10/Dell-R430%E5%AE%89%E8%A3%85pve8/" title="Dell R430安装pve8">Dell R430安装pve8</a><time datetime="2024-03-10T05:00:20.000Z" title="Created 2024-03-10 13:00:20">2024-03-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By WuJean</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>